---
title: "Recharts UDF"
author: "`r Sys.info()[['user']]`"
date: "`r format(Sys.time(),'%x %X')`"
output: 
  html_document: 
    css: ~/css/hms_blue.css
    fig_caption: yes
    fig_width: 8
    keep_md: yes
    number_sections: yes
    toc: yes
---

# Intro 前言

本工具来源于百度开发的国内顶尖水平的开源d3-js可视项目[Echarts](http://echarts.baidu.com/)([Github Repo](https://github.com/ecomfe/echarts))。Yang Zhou和Taiyun Wei基于该工具开发了[recharts](https://github.com/taiyun/recharts)包，经Yihui Xie[修改](https://github.com/yihui/recharts)后，可通过`htmlwidgets`传递js参数，大大简化了开发难度。但此包开发仍未完成。为了赶紧上手用，基于该包做了一个函数`echartR`，用于制作基础Echart交互图。

This tool originates from a top-tier d3-js visualization project of China: [Baidu Echarts](http://echarts.baidu.com/)([Github Repo](https://github.com/ecomfe/echarts)). Yang Zhou and Taiyun Wei developed an experimental R package [recharts](https://github.com/taiyun/recharts) based on it, which then evoluted into [yihui/recharts](https://github.com/yihui/recharts) by Yihui Xie to pass js parameters through `htmlwidgets`. The package is sill uder development. I developed a function `echartR` based on this package to make basic Echarts interation charts.

# Usage 用法
## Installation 安装
- 安装 Install `devtools` (`install.packages('devtools')`)
- 安装 Insall recharts (`install_github('yihui/recharts')`)
- 下载 Download `echartR`文件到本地位置 to local disk:  [https://github.com/madlogos/recharts/blob/master/R/echartR.R](https://github.com/madlogos/recharts/blob/master/R/echartR.R))
- 调用 Source `echartR` 脚本 script (假设我将脚本放在本地 suppose I stored the script to local GitHub Repo: `source("~/Github/recharts/R/echartR.R")`)

## Grammar 语法

```
echartR(data, x, y, z=NULL, series=NULL, weight=NULL,
        type="scatter", stack=FALSE, title=NULL, subtitle=NULL, 
        symbolList=NULL, dataZoom=NULL, 
        dataRange=NULL, splitNumber=NULL, dataRangePalette=NULL,
        xlab=NULL, ylab=NULL, xyflip=FALSE, AxisAtZero=TRUE, scale=TRUE,
        palette='aetnagreen', tooltip=TRUE, legend=TRUE,
        legend_pos=c('center','top'), 
        toolbox=TRUE, calculable=TRUE, asImage=FALSE))
```

- **data**: 数据集 dataset
- **x**: x变量 x variable
- **y**: y变量 y variable
- z: z变量，只接受时间/日期变量，并打开时间轴。z variable, only accept data/time variable to open time axis
- series: Series(系列)变量 series variable
- weight: 权重变量，可用于直方图、气泡图等 weight variable, used in histogram, bubble, etc
- type: 默认 default `scatter`，可选 options 'scatter', 'bubble', 'bar', 'line', 'linesmooth', 'map', 'k', 'pie', 'ring', 'area', 'areasmooth', 'chord', 'force', 'tree', 'treemap', 'wordcloud', 'heatmap', 'histogram', 'funnel', 'pyramid', 'radar', 'radarfill'
    - 如选择map，则控制项必须写作一个长度为3的向量：c('map',`mapType`,`area/point`)。mapType可选'world'、'china'，或简体中文表示的具体中国地名。area/point为area时，用区块颜色表示效应大小；为point时，用点在地图上做标注。默认为c('map','china','area')。If `map` was chosen, the control option should be a vector of length 3: c('map',`mapType`,`area/point`). `mapType` could be either 'world' or 'china', of which simplified Chinese names are required for 'china'. When `area/point` equals to 'area', the function colors polygons to show the effects; while equals to 'point', it ticks droplets on the map.
- stack: 默认FALSE，是否堆积。用于制作堆积条图、柱图、线图和面积图等。Default to FALSE (do not stack). Used in stacked hbar/vbar, line and area chart, etc.
- title: 标题 
- subtitle: 副标题
- symbolList: 图形标志。可使用数组循环使用。如设置为NULL或不设置，则循环显示Echarts默认的标志图形列表：c('circle','rectangle','triangle','diamond','emptyCircle','emptyRectangle','emptyTriangle','emptyDiamond')。也可任意指定'heart','droplet','pin','arrow','star5','star6'等非标图形。设为'none'则不显示。A vector assigning symbols. You can use an array of symbols. Do not set the value or set it NULL, the function circulates the default symbol list of Echarts c('circle','rectangle','triangle','diamond','emptyCircle','emptyRectangle','emptyTriangle','emptyDiamond'). You can also assign non-standard symbols like 'heart','droplet','pin','arrow','star5','star6', etc. When assigned to 'none', no symbols are shown.
- dataZoom: 数据缩放轴，默认FALSE. The axis to zoom data. Default to FALSE.
- dataRange: 数据范围漫游范围，默认不打开。如要打开，设置dataRange=c(`高值标签`,`低值标签`) The range to zoom the data. Default to FALSE. Set dataRange=c(`High value label`,`Low value label`) to enable dataRange.
- splitNumber: 如打开数据漫游，可指定数据范围切分段数，默认为连续漫游轴(0)。When dataRange is on, assign splitNumber to cut the range into discrete sections. Default to 0 (continuous range).
- dataRangePalette: 如打开数据漫游，可单独指定漫游色板(同palette功能)，否则采用Echarts默认值。You can independently assign palettes to dataRange (similar to overall palette). Default to NULL (applies echarts defaults).
- xlab: x轴标题 title of x-axis
- ylab: y轴标题 title of y-axis
- xyflip: 默认FALSE，是否翻转坐标轴。Flip x,y-axies. Default to FALSE.
- AxisAtZero: 默认TRUE，坐标轴是否交叉于零点。Axes cross at zero. Default to TRUE.
- scale: 默认TRUE，是否基于最大、最小值调整坐标尺度。Rescale the axes based on min and max values. Default to TRUE.
- palette: 默认aetnagreen，使用调色板。Overall palette. Default to 'aetnagreen'.
    - 种类 Palette names:
        - Aetna palettes: 可用 Including 'aetnagreen', 'aetnablue', 'aetnaviolet', 'aetnaorange', 'aetnateal', 'aetnacranberry'
        - RColorBrewer palettes: 可用 Including 'BrBG', 'PiYG', 'PRGn', 'PuOr', 'RdBu', 'RdGy', 'RdYlBu', 'RdYlGn', 'Spectral', 'Accent', 'Dark2', 'Paired', 'Pastel1', 'Pastel2', 'Set1', 'Set2', 'Set3', 'Blues', 'BuGn', 'BuPu', 'GnBu', 'Greens', 'Greys', 'Oranges', 'OrRd', 'PuBu', 'PuBuGn', 'PuRd', 'Purples', 'RdPu', 'Reds', 'YlGn', 'YlGnBu', 'YlOrBr', 'YlOrRd'
        - ggthemes palettes: 'calc', 'economist', 'economist_white', 'excel', 'few', 'fivethirtyeight', 'gdocs', 'pander', 'tableau', 'stata', 'tableau20', 'tableau10medium', 'tableaugray', 'tableauprgy', 'tableaublrd', 'tableaugnor', 'tableaucyclic', 'tableau10light', 'tableaublrd12','tableauprgy12', 'tableaugnor12','hc','darkunica', 'solarized','solarized_red', 'solarized_yellow', 'solarized_orange','solarized_magenta','solarized_violet', 'solarized_blue', 'solarized_cyan', 'solarized_green', 'wsj','colorblind', 'trafficlight'
        - 其他Other palette: 'rainbow', 'terrain'
    - 用法 Usage:
        - 可以不指定，使用函数默认。Do not set the value and function defaults will be loaded
        - 可以`palette=NULL`，使用Echarts默认。Set `palette=NULL` to use Echarts defaults
        - 可以`palette=palette name`指定上述任何一种色板。Set `palette=palette name` to assign any palette listed above
        - 规定色板的同时跟个数限定，限定色板颜色的个数，如`palette='calc(3)'`，会从calc色板中随机取3种颜色。Set `palette=palette name(number)` to restrict number of colors within the palette (e.g., `palette='calc(3)'` picks 3 colors out of 'calc' randomly)
        - 可以`palette=c(color1,color2,color3,...)`自定义色板向量，向量可以是颜色名，也可以是Hex表达式。可以用`colors()`函数查看所有支持的颜色名称，`demo(colors)`查看颜色效果。Set `palette=c(color1,color2,color3,...)` to define a palette vector, made of which either color names or Hex expressions. Use `colors()` to check available color names and check the effects using `demo(colors)`.
- tooltip: 默认TRUE，鼠标指针特效。Mouse tip effects swtich. Default to TRUE.
- legend: 默认TRUE，是否显示图例。Whether show the legend. Default to TRUE.
- legend_pos: 图例位置，可用c('left|center|right','top|center|bottom')，c("center","top")表示中间顶端位置。Legend position which is a vector of length 2 (c('left|center|right','top|center|bottom')). c('center','top') means top meiddle. 
- toolbox: 默认TRUE，是否显示工具箱。Echarts Tool box switch. Default to TRUE.
- calculable: 默认TRUE，是否支持拖曳重算(Echarts专利) Calculable switch (Echarts patent).
- asImage: 默认FALSE，是否出静态图。renderAsImage switch.Deafult to FALSE.

# Examples
```{r import R scripts,results='hide'}
Sys.setlocale("LC_ALL","Chinese")
source("~/Github/recharts/R/echartR.R")
#source("C:/HMSProjects/Data Analytics/R_scripts/CommonFunctions.R")
knitr::opts_chunk$set(message=FALSE,warning=FALSE,results='asis')
```

## Scatter 散点图
### Singular-series Scatter 单系列散点图
```{r mono-series scatter}
a<-echartR(data = iris, x = ~Sepal.Width, y = ~Petal.Width, 
        type = 'scatter', palette='solarized_magenta',
        title = 'Scatter - Sepal Width vs Petal Width (iris)', 
        xlab = 'Sepal Width', ylab = 'Petal Width')
```

显示范围从零点开始(`scale`=FALSE)：
```{r mono-series scatter at zero}
echartR(data = iris, x = ~Sepal.Width, y = ~Petal.Width, scale = F,
        type = 'scatter', palette='solarized_blue(3)',
        title = 'Scatter - Sepal Width vs Petal Width (iris)', 
        xlab = 'Sepal Width', ylab = 'Petal Width')
```

### Multi-series Scatter 多系列散点图
```{r multi-series scatter}
echartR(data = iris, x = ~Sepal.Width, y = ~Petal.Width, series = ~Species,
        type = 'scatter', palette='aetnaviolet', symbolList='circle',
        title = 'Scatter - Sepal Width vs Petal Width, by Species (iris)',
        xlab = 'Sepal Width', ylab = 'Petal Width')
```

使用三套标志图形(实心点、空心点、方块)区分数据系列
```{r multi-series scatter with multi-symbols}
echartR(data = iris, x = ~Sepal.Width, y = ~Petal.Width, series = ~Species,
        type = 'scatter', palette='aetnateal',
        symbolList=c('droplet','heart','star5'),
        title = 'Scatter - Sepal Width vs Petal Width, by Species (iris)',
        xlab = 'Sepal Width', ylab = 'Petal Width')
```

## Bubble 气泡图

气泡图同样来源于散点图。type改为`bubble`即可，如不指定`weight`变量，函数默认指定y为气泡权重。

### Singular-series Bubble 单系列气泡图
```{r mono-series bubble}
echartR(data = iris, x = ~Sepal.Width, y = ~Petal.Width, 
        weight = ~Petal.Length,
        type = 'bubble', palette='solarized_cyan',
        title = paste("Bubble - Sepal Width vs Petal Width,",
                      "weighed by Petal Length (iris)"),
        xlab = 'Sepal Width', ylab = 'Petal Width')
```

### Multi-series Bubble 多系列气泡图
用`rep('circle',nlevels(iris$Species))`设置3个数据系列均使用实心圆作为标志图形。palette设置为tableauGnOr(3)，只取该色板前3种颜色。
```{r multi-series bubble}
echartR(data = iris, x = ~Sepal.Width, y = ~Petal.Width, 
        weight = ~Petal.Length, series = ~Species, 
        symbolList='circle',
        type = 'bubble', palette='tableaugnor(3)',
        title = paste("Bubble - Sepal Width vs Petal Width, by Species,",
                      "weighed by Petal Length (iris)"), 
        xlab = 'Sepal Width', ylab = 'Petal Width')
```

## vBar 柱图

先生成一个汇总数据集`dtiris`。

```{r summary data}
library(reshape2)
dfiris <- iris
dfiris$id <- row.names(iris)
dfiris <- melt(dfiris,id=c("Species","id"))
names(dfiris) <- c("Species","id","Param","Value")
dtiris <- dcast(dfiris[,c(1,3,4)],Species+Param~.,value.var="Value",mean)
names(dtiris) <- c("Species","Param","Mean")
knitr::kable(dtiris,format='html',caption="Table: Mean of parameters (iris)")
```

### Unstacked vBar 平铺柱图
```{r unstack vbar}
echartR(data = dtiris, x = ~Param, y = ~Mean,  series = ~Species,
        type = 'bar', palette='fivethirtyeight',
        title = paste("VBar - Parameter Mean by Species", "(iris)"), 
        xlab = 'Parameter', ylab = 'Mean', legend_pos=c('right','center'))
```

### Stacked vBar 堆积柱图
```{r stack vbar}
echartR(data = dtiris, x = ~Param, y = ~Mean, 
        series = ~Species, stack=T,
        type = 'bar', palette='pander',
        title = paste("VBar - Parameter Mean by Species", "(iris)"), 
        xlab = 'Parameter', ylab = 'Mean', legend_pos=c('right','center'))
```

堆积与否，也可以简单地通过工具栏的`平铺`、`堆积`按钮切换。非常强大(但也得在函数配置项里正确地码出代码)。

## hBar 条图

条图和柱图的区别只在于`xyflip`开关选项。

### Unstacked hBar 平铺条图
```{r unstack hbar}
echartR(data = dtiris, x = ~Param, y = ~Mean, 
        series = ~Species, xyflip=T,
        type = 'bar', palette='stata(3)',
        title = paste("hBar - Parameter Mean by Species", "(iris)"), 
        xlab = 'Parameter', ylab = 'Mean', legend_pos=c('right','center'))
```

### Stacked hBar 堆积条图
palette设为calc的前4种颜色。
```{r stack hbar}
echartR(data = dtiris, x = ~Param, y = ~Mean, 
        series = ~Species, stack=T, xyflip=T,
        type = 'bar', palette='calc(4)',
        title = paste("hBar - Parameter Mean by Species", "(iris)"), 
        xlab = 'Parameter', ylab = 'Mean', legend_pos=c('right','center'))
```

## Pie 饼图

用`mtcars`作为作图数据集。

```{r pie data}
dtcars <- mtcars
dtcars$car <- row.names(dtcars)
dtcars$transmission <- as.factor(dtcars$am)
levels(dtcars$transmission) <- c("Automatic","Manual")
dtcars$cylinder <- as.factor(dtcars$cyl)
dtcars$carburetor <-as.factor(dtcars$carb)
```

```{r pie}
echartR(dtcars, x = ~transmission,  y = ~car, type='pie',
        palette='darkunica', 
        title='Number of Automatic/manual trasmitted cars (mtcars)')
```

## Ring 环图

环形图是饼图的变形，只需将`type`改为ring。Echarts中只需要把饼图的半径参数扩展为包含内外径的数组即可。

```{r ring}
echartR(dtcars, x = ~cylinder,  y = ~car, type='ring',
        palette='hc', title='Number of Cylinders (mtcars)')
```

## Line 线图

### Unstacked Line 平铺线图
打开数据缩放`dataZoom=T`
```{r line}
airquality$Date <- as.Date(with(airquality,paste(2015,Month,Day,sep="-")))
airquality$strDate <- with(airquality,paste(2015,Month,Day,sep="-"))
airquality$TempG <- cut(airquality$Temp,breaks=c(0,60,70,80,100))
a=echartR(airquality, x = ~Date, y= ~Wind, weight=~Solar.R,
          type='line', dataZoom=T,
        palette='tableauBlRd', xlab = 'Date', ylab = 'Wind',
        title='Wind by day (airquality)')

a=echartR(airquality, x = ~Day, y= ~Wind, series=~Month,
          type='line', dataZoom=T,
        palette='tableauBlRd', xlab = 'Date', ylab = 'Wind',
        title='Wind by day (airquality)')

echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='line', dataZoom=T,
        palette='tableauBlRd', xlab = 'Sample ID', ylab = 'Measure',
        title='Parameter measures (iris)')
```

线段平滑，不显示标志图形(`symbolList='none'`)。Echarts对缺失值默认不填补，因此有很多断线。
```{r linesmooth}
airq <- melt(airquality[,c("Ozone","Solar.R","Wind","Temp","strDate")],
             id=c("strDate"))
echartR(airq, x = ~strDate, y= ~value, series= ~variable, type='linesmooth',
        symbolList='none',
        palette='tableauPrGy(4)', xlab = 'Date', ylab = 'Measure',
        title='Climate measures by day (airquality)')
```

### Stacked Line 堆积线图
```{r line stacked}
echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='line',stack=T,
        palette='tableauBlRd12', xlab = 'Sample ID', ylab = 'Measure',
        title='Parameter measures (iris)')
```

线段平滑，不显示标志图形
```{r line stacked smooth}
echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='linesmooth',stack=T,
        palette='tableauGnOr12', xlab = 'Sample ID', ylab = 'Measure',
        symbolList='none',
        title='Parameter measures (iris)')
```

## Area 面积图
Echarts中，面积图本质上被定义为线图，仅通过`itemStyle`参数渲染颜色。

### Unstacked Area 平铺面积图
```{r area}
echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='area',
        palette='brbg', xlab = 'Sample ID', ylab = 'Measure',
        title='Parameter measures (iris)')
```

线段平滑，并打开数据缩放
```{r areasmooth}
echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='areasmooth',
        palette='PiYG(4)', xlab = 'Sample ID', ylab = 'Measure', 
        symbolList='none', dataZoom=T,
        title='Parameter measures (iris)')
```

### Stacked Area 堆积面积图
```{r area stacked}
echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='area',stack=T,
        palette='PRGn(5)', xlab = 'Sample ID', ylab = 'Measure',
        symbolList='emptyCircle',
        title='Parameter measures (iris)')
```

线段平滑。自定义色板向量。
```{r area stacked smooth}
echartR(dfiris, x = ~id, y= ~Value, series= ~Param, type='areasmooth',stack=T,
        palette=c('red','yellow','limegreen','skyblue'), 
        xlab = 'Sample ID', ylab = 'Measure', 
        symbolList='none',
        title='Parameter measures (iris)')
```

## Histogram 直方图



## Funnel 漏斗图

### Funnel 普通漏斗图
```{r funnel}
echartR(dtcars, x = ~carburetor,  y = ~car, type='funnel',
        palette='RdBu', title='Number of carburetors of cars (mtcars)')
```

### Pyramid 金字塔图
金字塔图即逆序漏斗图

```{r pyramid}
echartR(dtcars, x = ~carburetor,  y = ~car, type='pyramid',
        palette='RdGy', title='Number of carburetors of cars (mtcars)')
```

## Radar 雷达图

### Empty Radar 空心雷达
```{r radar empty}
player <- rbind(data.frame(name=rep("Philipp Lahm",8),
                     para=c("Passing%","Key passing","Comp crosses","Crossing%",
                            "Successful dribbles","Dispossessed","Dribbled past",
                            "Fouls"),
                     value=c(89.67,1.51,0.97,24.32, 0.83,0.86,1.15, 0.47)),
                data.frame(name=rep("Dani Alves",8),
                     para=c("Passing%","Key passing","Comp crosses","Crossing%",
                            "Successful dribbles","Dispossessed","Dribbled past",
                            "Fouls"),
                     value=c(86.62,2.11,0.99,20.78,1.58,1.64,0.9,1.71)))
echartR(player, x=~para, y=~value, series=~name, type='radar',
        symbolList=rep('none',2),
        title='Lahm vs Alves (by @mixedknuts)', palette=c('red','blue'))
```

### Solid Radar 实心雷达

```{r radar solid}
echartR(player, x=~para, y=~value, series=~name, type='radarfill',
        symbolList='none', palette=c('firebrick1','dodgerblue'),
        title='Lahm vs Alves (by @mixedknuts)')
```

## Map 地图

R和Rstudio的中文转码在Windows里一直是老大难。在这里，Rstudio的默认编码采用CP936编码，文档用UTF-8。如直接在程序内读数据集，用iconv转码后，落单的汉字仍然会显示为乱码。可先下载[ChinaGDP.txt](https://raw.githubusercontent.com/madlogos/Shared_Doc/master/Shared_Documents/ChinaGDP.txt)到本地，`readLines`读入。

```{r map gdp data}
#gdp <- readLines("https://raw.githubusercontent.com/madlogos/Shared_Doc/master/Shared_Documents/ChinaGDP.txt")
gdp <- readLines("ChinaGDP.txt")
dtgdp <- unlist(strsplit(gdp,split=","))
dtgdp <- as.data.frame(t(matrix(dtgdp,nrow=3)),stringsAsFactors=F)
names(dtgdp) <- c('Year','Prov',"GDP")
dtgdp$GDP <- as.numeric(dtgdp$GDP) 
knitr::kable(dcast(dtgdp,Prov~Year,sum,value.var="GDP"), format='html',
         caption="Table: 2012-2014 GDP of Provinces in China (Million USD)")

dtgdp$Prov <- as.factor(enc2native(dtgdp$Prov))
dtgdp$Year<- as.factor(dtgdp$Year)
```

### Area 区块标注

开启数据漫游，并定义色板。
```{r china map area}
echartR(dtgdp, x = ~Prov, y = ~GDP, series= ~Year, 
        type=c('map','china','area'), palette='gdocs(3)',
        title="GDPs of China Provinces, 2012-2014 (Million USD)",
        dataRangePalette=c('red','orange','yellow','limegreen','green'),
        dataRange=c('High',"Low"))
```

用世界GDP前20粗糙演示世界地图。漫游轴切分为10档。

```{r world map area}
worldgdp <- data.frame(
    country=c('United States of America','China','Japan','Germany',
              'United Kingdom','France','Brazil', 'Italy','India','Russia',
              'Canada','Australia','South Korea','Spain','Mexico','Indonesia',
             'Netherlands','Turkey','Saudi Arabia','Switzerland'),
    GDP=c(17418925,10380380,4616335,3859547,2945146,2846889,2353025,2147952,
          2049501,1857461,1788717,1444189,1416949,1406855,1282725,888648,866354,
          806108,752459,712050))
echartR(worldgdp, x = ~country, y = ~GDP, type=c('map','world','area'),
        title="Nations with top 20 GDPs, 2014 (Million USD) - Wikipedia",
        dataRangePalette='rainbow(6)', dataRange=c("High","Low"), 
        splitNumber=10)
```

### Point 点标注


## Chord 和弦图


## Force 力导向布局图

